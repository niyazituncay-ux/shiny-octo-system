<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tuncay Holding</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a2a; --muted:#9fb0d0; --text:#e9f0ff; --line:#24304a;
      --pos:#37d67a; --neg:#ff6b6b; --btn:#0d1423; --btnP:#17305e; --btnD:#3a1520;
      --field:#0b1220;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);padding:18px;}
    h1{margin:0 0 6px;font-size:30px}
    h2{margin:0 0 10px;font-size:16px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:14px;line-height:1.35}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;max-width:1100px;margin:0 auto 14px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .btn{border:1px solid var(--line);background:var(--btn);color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--btnP);border-color:#2c4a86}
    .btn.danger{background:var(--btnD);border-color:#6b2a3c}
    .btn:hover{border-color:#3a4b73}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .f{grid-column:span 12}
    @media (min-width:760px){
      .f.sm6{grid-column:span 6}
      .f.sm4{grid-column:span 4}
      .f.sm3{grid-column:span 3}
    }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input{width:100%;box-sizing:border-box;padding:10px;border-radius:10px;border:1px solid var(--line);background:var(--field);color:var(--text)}
    .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media (min-width:760px){.kpis{grid-template-columns:repeat(4,1fr)}}
    .kpi{background:var(--field);border:1px solid var(--line);border-radius:12px;padding:10px}
    .kpi .t{color:var(--muted);font-size:12px}
    .kpi .v{margin-top:6px;font-weight:800;font-size:16px}
    .pos{color:var(--pos)} .neg{color:var(--neg)}
    details{border-radius:14px;border:1px solid var(--line);background:rgba(18,26,42,.6);max-width:1100px;margin:0 auto 10px}
    summary{cursor:pointer;padding:12px 14px;list-style:none}
    summary::-webkit-details-marker{display:none}
    .inner{padding:0 14px 14px;border-top:1px solid var(--line)}
    .pill{display:inline-block;font-size:12px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
    .tiny{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .hint{background:#0b1220;border:1px dashed #2c3f63;border-radius:12px;padding:10px;color:var(--muted);font-size:12px}
  </style>
</head>

<body>
  <div class="card">
    <h1>Tuncay Holding</h1>
    <div class="sub">
      Version: <b>STABLE + EDIT + TOTAL + SHARE</b><br/>
      Cashflow = <b>Warmmiete</b> − <b>Nebenkosten (ihr zahlt)</b> − <b>Rate</b>
      <div class="tiny" id="loadedInfo"></div>
    </div>

    <div class="row">
      <button class="btn" id="prevYear">◀ Jahr</button>
      <div class="pill">Jahr: <b id="yearLabel"></b></div>
      <button class="btn" id="nextYear">Jahr ▶</button>

      <div class="right row">
        <button class="btn" id="shareBtn">Share-Link</button>
        <button class="btn" id="exportBtn">Export</button>
        <button class="btn" id="importBtn">Import</button>
        <button class="btn danger" id="resetBtn">Reset</button>
      </div>
    </div>
  </div>

  <!-- Gesamtbilanz -->
  <div class="card">
    <h2>Gesamtbilanz (ausgewähltes Jahr)</h2>
    <div class="kpis">
      <div class="kpi"><div class="t">Gesamt-Restschuld (Jahresende)</div><div class="v" id="tot_balance">–</div></div>
      <div class="kpi"><div class="t">Gesamt Zinsen (Jahr)</div><div class="v" id="tot_interest">–</div></div>
      <div class="kpi"><div class="t">Gesamt Tilgung (Jahr)</div><div class="v" id="tot_principal">–</div></div>
      <div class="kpi"><div class="t">Gesamt Cashflow (Jahr)</div><div class="v" id="tot_cf_year">–</div></div>
    </div>
    <div class="kpis" style="margin-top:10px">
      <div class="kpi"><div class="t">Gesamt Cashflow (Monat Ø)</div><div class="v" id="tot_cf_month">–</div></div>
      <div class="kpi"><div class="t">Gesamt Warmmiete (Monat)</div><div class="v" id="tot_warm_month">–</div></div>
      <div class="kpi"><div class="t">Gesamt Nebenkosten (Monat)</div><div class="v" id="tot_util_month">–</div></div>
      <div class="kpi"><div class="t">Gesamt Rate (Monat)</div><div class="v" id="tot_rate_month">–</div></div>
    </div>
  </div>

  <!-- Kopfkarte -->
  <div class="card">
    <div class="row">
      <h2 style="margin:0">Neues Objekt anlegen (Kopfkarte)</h2>
      <div class="right">
        <span class="pill" id="editPill" style="display:none">Bearbeiten aktiv</span>
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div class="f sm6">
        <label>Objektname</label>
        <input id="p_name" placeholder="z. B. MFH Breslauerstraße 12">
      </div>
      <div class="f sm3">
        <label>Einheiten</label>
        <input id="p_units" type="number" min="1" step="1" placeholder="z. B. 6">
      </div>
      <div class="f sm3">
        <label>Start Darlehen (YYYY-MM)</label>
        <input id="l_start" placeholder="z. B. 2021-04">
      </div>

      <div class="f sm4">
        <label>Startschuld (€)</label>
        <input id="l_principal" type="number" step="0.01" placeholder="z. B. 320000">
      </div>
      <div class="f sm4">
        <label>Zins p.a. (%)</label>
        <input id="l_interest" type="number" step="0.0001" placeholder="z. B. 1.93">
      </div>
      <div class="f sm4">
        <label>Rate / Monat (€)</label>
        <input id="l_payment" type="number" step="0.01" placeholder="z. B. 2690">
      </div>

      <div class="f sm6">
        <label>Nebenkosten (ihr zahlt) / Monat (€)</label>
        <input id="cf_util" type="number" step="0.01" placeholder="z. B. 280">
      </div>

      <div class="f sm6">
        <label>Warmmieten pro Einheit (monatlich)</label>
        <div id="unitRents"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="buildUnits">Felder erstellen / aktualisieren</button>
          <span class="tiny">Pro Einheit ein Warmmiet-Feld.</span>
        </div>
      </div>

      <div class="f sm6">
        <label>&nbsp;</label>
        <div class="row">
          <button class="btn primary" id="saveProperty">Objekt speichern ✅</button>
          <button class="btn" id="cancelEdit" style="display:none">Bearbeitung abbrechen</button>
          <span class="tiny" id="saveMsg"></span>
        </div>
      </div>

      <div class="f">
        <div class="hint">
          Tipp: Nach „Einheiten“ bitte <b>Felder erstellen</b> drücken, dann Warmmieten eintragen.
          Share-Link teilt immer die <b>aktuellen</b> gespeicherten Objekte.
        </div>
      </div>
    </div>
  </div>

  <div id="list"></div>

<script>
(() => {
  // === STORAGE ===
  const STORAGE_KEY = "tuncay_holding_objects_v1";

  const el = (id) => document.getElementById(id);
  const fmtEur = (n) => new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(isFinite(n)?n:0);
  const round2 = (n) => Math.round((n + Number.EPSILON) * 100) / 100;

  function cashClass(v){ return v >= 0 ? "pos" : "neg"; }

  function parseYearMonth(s){
    const m = /^(\d{4})-(\d{2})$/.exec((s||"").trim());
    if(!m) return null;
    const y = +m[1], mo = +m[2];
    if(mo<1 || mo>12) return null;
    return {y, m: mo};
  }
  function monthIndex(y,m){ return y*12 + (m-1); }
  function fromMonthIndex(idx){
    const y = Math.floor(idx/12);
    const m = (idx % 12) + 1;
    return {y,m};
  }

  function normalize(p){
    const id = p.id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));
    const name = (p.name||"").trim() || "Unbenannt";
    const units = Math.max(1, Math.floor(+p.units || 1));

    const loan = p.loan || {};
    const startYm = (loan.startYm || p.startYm || "").trim();
    const principal = +loan.principal || 0;
    const interestPa = +loan.interestPa || 0;
    const paymentMonthly = +loan.paymentMonthly || 0;

    let unitRents = Array.isArray(p.unitRents) ? p.unitRents.map(x=>+x||0) : [];
    unitRents = unitRents.slice(0, units);
    while(unitRents.length < units) unitRents.push(0);

    const utilitiesMonthly = +p.utilitiesMonthly || 0;

    return {
      id, name, units,
      unitRents,
      utilitiesMonthly: isFinite(utilitiesMonthly)?utilitiesMonthly:0,
      loan: {
        startYm,
        principal: isFinite(principal)?principal:0,
        interestPa: isFinite(interestPa)?interestPa:0,
        paymentMonthly: isFinite(paymentMonthly)?paymentMonthly:0
      }
    };
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const data = JSON.parse(raw);
      if(!Array.isArray(data)) return [];
      return data.map(normalize);
    }catch{ return []; }
  }
  function persist(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(props));
  }

  // === SHARE-LINK ENCODE/DECODE ===
  // UTF-8 safe base64 in hash (#data=...)
  function encodeToUrlData(obj){
    const json = JSON.stringify(obj);
    const b64 = btoa(unescape(encodeURIComponent(json)));
    return encodeURIComponent(b64);
  }
  function decodeFromUrlData(s){
    const b64 = decodeURIComponent(s);
    const json = decodeURIComponent(escape(atob(b64)));
    return JSON.parse(json);
  }

  // === APP STATE ===
  let props = load();
  let selectedYear = new Date().getFullYear();
  let editingId = null;

  // === UI HELPERS ===
  function setEditMode(on){
    el("editPill").style.display = on ? "inline-block" : "none";
    el("cancelEdit").style.display = on ? "inline-block" : "none";
    el("saveProperty").textContent = on ? "Änderungen speichern ✅" : "Objekt speichern ✅";
  }
  function clearForm(){
    el("p_name").value="";
    el("p_units").value="";
    el("l_start").value="";
    el("l_principal").value="";
    el("l_interest").value="";
    el("l_payment").value="";
    el("cf_util").value="";
    el("unitRents").innerHTML="";
    el("saveMsg").textContent="";
    editingId=null;
    setEditMode(false);
  }

  function readUnitRents(){
    return [...el("unitRents").querySelectorAll("input[data-unit]")].map(i => +i.value || 0);
  }
  function buildUnitRentFields(units, existing=[]){
    const wrap = el("unitRents");
    wrap.innerHTML="";
    const n = Math.max(0, Math.floor(units||0));
    for(let i=0;i<n;i++){
      const d = document.createElement("div");
      d.style.marginBottom="8px";
      d.innerHTML = `
        <label class="tiny">Einheit ${i+1} – Warmmiete/Monat (€)</label>
        <input type="number" step="0.01" data-unit="${i}" value="${existing[i] ?? ""}">
      `;
      wrap.appendChild(d);
    }
  }

  el("buildUnits").onclick=(e)=>{
    e.preventDefault();
    const units = +el("p_units").value;
    buildUnitRentFields(units, readUnitRents());
  };

  // === CALC ===
  function calcYear(p, year){
    const start = parseYearMonth(p.loan.startYm);
    if(!start) return null;

    const iMonthly = (p.loan.interestPa/100)/12;
    const payment = +p.loan.paymentMonthly || 0;

    const startIdx = monthIndex(start.y, start.m);
    const endIdx = monthIndex(year, 12);

    let balance = +p.loan.principal || 0;
    let interestPaid=0, principalPaid=0;

    for(let idx=startIdx; idx<=endIdx; idx++){
      if(balance <= 0 || payment <= 0) { balance = Math.max(0,balance); break; }

      const interest = balance * iMonthly;
      let rate = payment;

      // bei letzter Rate nicht überzahlen
      const need = balance + interest;
      if(rate > need) rate = need;

      const prin = Math.max(0, rate - interest);
      balance = balance - prin;

      const ym = fromMonthIndex(idx);
      if(ym.y === year){
        interestPaid += interest;
        principalPaid += prin;
      }
    }

    const warmMonth = (p.unitRents||[]).reduce((s,x)=>s+(+x||0),0);
    const utilMonth = +p.utilitiesMonthly||0;
    const cfMonth = warmMonth - utilMonth - payment;

    return {
      balanceEnd: round2(balance),
      interestPaid: round2(interestPaid),
      principalPaid: round2(principalPaid),
      cfMonth: round2(cfMonth),
      cfYear: round2(cfMonth * 12),
      warmMonth: round2(warmMonth),
      utilMonth: round2(utilMonth),
      rateMonth: round2(payment)
    };
  }

  function renderTotals(){
    let totBal=0, totInt=0, totPrin=0, totCfYear=0, totWarm=0, totUtil=0, totRate=0;

    props.forEach(p=>{
      const y = calcYear(p, selectedYear);
      if(!y) return;
      totBal += y.balanceEnd;
      totInt += y.interestPaid;
      totPrin += y.principalPaid;
      totCfYear += y.cfYear;
      totWarm += y.warmMonth;
      totUtil += y.utilMonth;
      totRate += y.rateMonth;
    });

    el("tot_balance").textContent = fmtEur(round2(totBal));
    el("tot_interest").textContent = fmtEur(round2(totInt));
    el("tot_principal").textContent = fmtEur(round2(totPrin));

    const cfYearEl = el("tot_cf_year");
    cfYearEl.textContent = fmtEur(round2(totCfYear));
    cfYearEl.className = "v " + cashClass(totCfYear);

    const cfMonth = totCfYear/12;
    const cfMonthEl = el("tot_cf_month");
    cfMonthEl.textContent = fmtEur(round2(cfMonth));
    cfMonthEl.className = "v " + cashClass(cfMonth);

    el("tot_warm_month").textContent = fmtEur(round2(totWarm));
    el("tot_util_month").textContent = fmtEur(round2(totUtil));
    el("tot_rate_month").textContent = fmtEur(round2(totRate));
  }

  function renderList(){
    const list = el("list");
    list.innerHTML = "";

    if(!props.length){
      const c = document.createElement("div");
      c.className = "card";
      c.innerHTML = `<div class="tiny">Noch keine Objekte gespeichert.</div>`;
      list.appendChild(c);
      return;
    }

    props.forEach(p=>{
      const y = calcYear(p, selectedYear);
      const cfM = y ? y.cfMonth : 0;

      const det = document.createElement("details");
      const sum = document.createElement("summary");
      sum.innerHTML = `
        <div class="row" style="width:100%">
          <div>
            <div style="font-weight:800">${p.name}</div>
            <div class="tiny">${p.units} Einheiten · Start ${p.loan.startYm} · Rate ${fmtEur(p.loan.paymentMonthly)}/Monat</div>
          </div>
          <div class="pill">Cashflow: <b class="${cashClass(cfM)}">${fmtEur(cfM)}/Monat</b></div>
        </div>
      `;

      const inner = document.createElement("div");
      inner.className = "inner";

      inner.innerHTML = `
        <div class="kpis" style="margin-top:12px">
          <div class="kpi"><div class="t">Restschuld (Jahresende)</div><div class="v">${fmtEur(y?.balanceEnd||0)}</div></div>
          <div class="kpi"><div class="t">Warmmiete (Monat)</div><div class="v">${fmtEur(y?.warmMonth||0)}</div></div>
          <div class="kpi"><div class="t">Nebenkosten (Monat)</div><div class="v">${fmtEur(y?.utilMonth||0)}</div></div>
          <div class="kpi"><div class="t">Cashflow (Jahr)</div><div class="v ${cashClass(y?.cfYear||0)}">${fmtEur(y?.cfYear||0)}</div></div>
        </div>

        <div class="kpis" style="margin-top:10px">
          <div class="kpi"><div class="t">Zinsen (Jahr)</div><div class="v">${fmtEur(y?.interestPaid||0)}</div></div>
          <div class="kpi"><div class="t">Tilgung (Jahr)</div><div class="v">${fmtEur(y?.principalPaid||0)}</div></div>
          <div class="kpi"><div class="t">Cashflow (Monat)</div><div class="v ${cashClass(cfM)}">${fmtEur(cfM)}</div></div>
          <div class="kpi"><div class="t">Rate (Monat)</div><div class="v">${fmtEur(y?.rateMonth||0)}</div></div>
        </div>

        <div class="hr"></div>
        <div class="tiny">
          Warmmieten je Einheit: ${(p.unitRents||[]).map((r,i)=>`E${i+1}: ${fmtEur(+r||0)}`).join(" · ") || "—"}
        </div>

        <div class="hr"></div>
        <div class="row">
          <button class="btn" data-edit="${p.id}">Bearbeiten</button>
          <button class="btn danger" data-del="${p.id}">Objekt löschen</button>
        </div>
      `;

      det.appendChild(sum);
      det.appendChild(inner);
      list.appendChild(det);
    });

    // Delete
    document.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick=()=>{
        const id=b.getAttribute("data-del");
        if(!confirm("Objekt wirklich löschen?")) return;
        props = props.filter(x=>x.id!==id);
        persist();
        if(editingId===id) clearForm();
        render();
      };
    });

    // Edit
    document.querySelectorAll("[data-edit]").forEach(b=>{
      b.onclick=()=>{
        const id=b.getAttribute("data-edit");
        const p=props.find(x=>x.id===id);
        if(!p) return;

        editingId = id;
        setEditMode(true);

        el("p_name").value = p.name || "";
        el("p_units").value = p.units || "";
        el("l_start").value = p.loan.startYm || "";
        el("l_principal").value = p.loan.principal ?? "";
        el("l_interest").value = p.loan.interestPa ?? "";
        el("l_payment").value = p.loan.paymentMonthly ?? "";
        el("cf_util").value = p.utilitiesMonthly ?? "";

        buildUnitRentFields(p.units, p.unitRents||[]);
        el("saveMsg").textContent = "Bearbeitung geladen. Ändern → speichern.";
        window.scrollTo({top:0, behavior:"smooth"});
      };
    });
  }

  function render(){
    el("yearLabel").textContent = selectedYear;
    el("loadedInfo").textContent = `Gespeichert: ${props.length} Objekt(e) (bleibt nach Reload)`;
    renderTotals();
    renderList();
  }

  // === SAVE / UPDATE ===
  el("saveProperty").onclick=(e)=>{
    e.preventDefault();

    const name=(el("p_name").value||"").trim();
    const units=Math.max(0, Math.floor(+el("p_units").value));
    const startYm=(el("l_start").value||"").trim();
    const principal=+el("l_principal").value;
    const interestPa=+el("l_interest").value;
    const paymentMonthly=+el("l_payment").value;
    const utilitiesMonthly=+el("cf_util").value;

    const rentInputs=[...el("unitRents").querySelectorAll("input[data-unit]")];
    const unitRents=rentInputs.map(i=>+i.value||0);

    const errors=[];
    if(!name) errors.push("Objektname fehlt");
    if(!units || units<1) errors.push("Einheiten muss >=1 sein");
    if(!parseYearMonth(startYm)) errors.push("Startdatum muss YYYY-MM sein");
    if(!isFinite(principal) || principal<=0) errors.push("Startschuld ungültig");
    if(!isFinite(paymentMonthly) || paymentMonthly<=0) errors.push("Rate ungültig");
    if(rentInputs.length!==units) errors.push("Bitte Felder erstellen/aktualisieren (Warmmieten)");

    if(errors.length){
      el("saveMsg").textContent = "❌ " + errors.join(" · ");
      return;
    }

    const obj = normalize({
      id: editingId || undefined,
      name, units, unitRents,
      utilitiesMonthly: isFinite(utilitiesMonthly) ? utilitiesMonthly : 0,
      loan: { startYm, principal, interestPa, paymentMonthly }
    });

    if(editingId){
      const idx = props.findIndex(x=>x.id===editingId);
      if(idx>=0) props[idx] = obj;
    }else{
      props.push(obj);
    }

    persist();
    clearForm();
    render();
  };

  el("cancelEdit").onclick=(e)=>{ e.preventDefault(); clearForm(); render(); };

  // === YEAR NAV ===
  el("prevYear").onclick=()=>{ selectedYear--; render(); };
  el("nextYear").onclick=()=>{ selectedYear++; render(); };

  // === EXPORT/IMPORT ===
  el("exportBtn").onclick=()=>{ prompt("Kopieren:", JSON.stringify(props,null,2)); };

  el("importBtn").onclick=()=>{
    const raw=prompt("JSON einfügen:");
    if(!raw) return;
    try{
      const data=JSON.parse(raw);
      if(!Array.isArray(data)) throw new Error("Format falsch");
      props = data.map(normalize);
      persist();
      clearForm();
      render();
      alert("✅ Import ok");
    }catch(err){
      alert("Import Fehler: " + (err.message || err));
    }
  };

  el("resetBtn").onclick=()=>{
    if(!confirm("Alles löschen?")) return;
    props=[];
    persist();
    clearForm();
    render();
  };

  // === SHARE-LINK BUTTON ===
  el("shareBtn").onclick = async () => {
    try{
      const data = encodeToUrlData(props);
      const base = location.origin + location.pathname;
      const url = base + "#data=" + data;

      // iOS/Android: nativer Teilen-Dialog (WhatsApp etc.)
      if (navigator.share) {
        await navigator.share({ title: "Tuncay Holding", text: "Immobilien-Daten", url });
        return;
      }

      // Fallback: Clipboard oder Prompt
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(url);
        alert("✅ Link kopiert. Jetzt in WhatsApp einfügen.");
      } else {
        prompt("Link kopieren:", url);
      }
    }catch(err){
      alert("Share-Link Fehler: " + (err.message || err));
    }
  };

  // === AUTO-IMPORT FROM LINK (#data=...) ===
  (function importFromHashIfAny(){
    try{
      const h = location.hash || "";
      if(!h.startsWith("#data=")) return;

      const dataPart = h.slice("#data=".length);
      const incoming = decodeFromUrlData(dataPart);

      if(!Array.isArray(incoming)) return;

      const ok = confirm("Link enthält Daten. Importieren? (überschreibt deine aktuellen Daten)");
      if(!ok) return;

      props = incoming.map(normalize);
      persist();
      clearForm();
      render();

      // Hash entfernen (damit es nicht jedes Mal fragt)
      history.replaceState(null, "", location.pathname + location.search);
      alert("✅ Import abgeschlossen.");
    }catch(err){
      alert("Import aus Link fehlgeschlagen: " + (err.message || err));
    }
  })();

  // init
  setEditMode(false);
  render();
})();
</script>
</body>
</html>
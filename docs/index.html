<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tunjay Holding</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a2a; --muted:#9fb0d0; --text:#e9f0ff; --line:#24304a;
      --pos:#37d67a; --neg:#ff6b6b; --btn:#0d1423; --btnP:#17305e; --btnD:#3a1520;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);padding:18px;}
    h1{margin:0 0 6px;font-size:30px}
    h2{margin:0 0 10px;font-size:16px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:14px;line-height:1.35}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;max-width:1100px;margin:0 auto 14px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .btn{border:1px solid var(--line);background:var(--btn);color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--btnP);border-color:#2c4a86}
    .btn.danger{background:var(--btnD);border-color:#6b2a3c}
    .btn:hover{border-color:#3a4b73}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .f{grid-column:span 12}
    @media (min-width:760px){
      .f.sm6{grid-column:span 6}
      .f.sm4{grid-column:span 4}
      .f.sm3{grid-column:span 3}
    }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input{width:100%;box-sizing:border-box;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
    details{border-radius:14px;border:1px solid var(--line);background:rgba(18,26,42,.6);max-width:1100px;margin:0 auto 10px}
    summary{cursor:pointer;padding:12px 14px;list-style:none}
    summary::-webkit-details-marker{display:none}
    .inner{padding:0 14px 14px;border-top:1px solid var(--line)}
    .pill{display:inline-block;font-size:12px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
    .tiny{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .pos{color:var(--pos)} .neg{color:var(--neg)}
  </style>
</head>

<body>
  <div class="card">
    <h1>Tunjay Holding</h1>
    <div class="sub">
      Version: <b>PERSIST+EDIT</b> · Daten bleiben nach Reload erhalten (localStorage).
      <div class="tiny" id="loadedInfo"></div>
    </div>

    <div class="row">
      <button class="btn" id="prevYear">◀ Jahr</button>
      <div class="pill">Jahr: <b id="yearLabel"></b></div>
      <button class="btn" id="nextYear">Jahr ▶</button>

      <div class="right row">
        <button class="btn" id="exportBtn">Export</button>
        <button class="btn" id="importBtn">Import</button>
        <button class="btn danger" id="resetBtn">Reset</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <h2 style="margin:0">Objekt anlegen / bearbeiten</h2>
      <div class="right">
        <span class="pill" id="editPill" style="display:none">Bearbeiten aktiv</span>
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div class="f sm6">
        <label>Objektname</label>
        <input id="p_name">
      </div>
      <div class="f sm3">
        <label>Einheiten</label>
        <input id="p_units" type="number" min="1" step="1">
      </div>
      <div class="f sm3">
        <label>Start Darlehen (YYYY-MM)</label>
        <input id="l_start" placeholder="2024-01">
      </div>

      <div class="f sm4">
        <label>Startschuld (€)</label>
        <input id="l_principal" type="number" step="0.01">
      </div>
      <div class="f sm4">
        <label>Zins p.a. (%)</label>
        <input id="l_interest" type="number" step="0.0001">
      </div>
      <div class="f sm4">
        <label>Rate / Monat (€)</label>
        <input id="l_payment" type="number" step="0.01">
      </div>

      <div class="f sm6">
        <label>Nebenkosten (ihr zahlt) / Monat (€)</label>
        <input id="cf_util" type="number" step="0.01">
      </div>

      <div class="f sm6">
        <label>Warmmieten pro Einheit (monatlich)</label>
        <div id="unitRents"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="buildUnits">Felder erstellen / aktualisieren</button>
          <span class="tiny">Pro Einheit eine Warmmiete.</span>
        </div>
      </div>

      <div class="f sm6">
        <label>&nbsp;</label>
        <div class="row">
          <button class="btn primary" id="saveProperty">Objekt speichern ✅</button>
          <button class="btn" id="cancelEdit" style="display:none">Bearbeitung abbrechen</button>
          <span class="tiny" id="saveMsg"></span>
        </div>
      </div>
    </div>
  </div>

  <div id="list"></div>

<script>
(() => {
  // FIXER KEY: nie mehr ändern, sonst wirken Daten "weg"
  const STORAGE_KEY = "tunjay_holding_properties";

  const el = (id) => document.getElementById(id);
  const fmtEur = (n) => new Intl.NumberFormat("de-DE", {style:"currency", currency:"EUR"}).format(isFinite(n)?n:0);

  function parseYearMonth(s){
    const m = /^(\d{4})-(\d{2})$/.exec((s||"").trim());
    if(!m) return null;
    const y = +m[1], mo = +m[2];
    if(mo<1 || mo>12) return null;
    return {y, m: mo};
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const data = raw ? JSON.parse(raw) : [];
      return Array.isArray(data) ? data : [];
    }catch{
      return [];
    }
  }
  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(props));
  }

  let props = load();
  el("loadedInfo").textContent = `Geladen: ${props.length} Objekt(e)`;

  let selectedYear = new Date().getFullYear();

  // --- Edit mode
  let editingId = null;
  function setEditMode(on){
    el("editPill").style.display = on ? "inline-block" : "none";
    el("cancelEdit").style.display = on ? "inline-block" : "none";
    el("saveProperty").textContent = on ? "Änderungen speichern ✅" : "Objekt speichern ✅";
  }

  function clearForm(){
    el("p_name").value="";
    el("p_units").value="";
    el("l_start").value="";
    el("l_principal").value="";
    el("l_interest").value="";
    el("l_payment").value="";
    el("cf_util").value="";
    el("unitRents").innerHTML="";
    el("saveMsg").textContent="";
    editingId=null;
    setEditMode(false);
  }

  // --- Units
  function readUnitRents(){
    return [...el("unitRents").querySelectorAll("input[data-unit]")].map(i => +i.value || 0);
  }
  function buildUnitRentFields(units, existing=[]){
    const wrap = el("unitRents");
    wrap.innerHTML="";
    const n = Math.max(0, Math.floor(units||0));
    for(let i=0;i<n;i++){
      const d=document.createElement("div");
      d.style.marginBottom="8px";
      d.innerHTML=`
        <label class="tiny">Einheit ${i+1} – Warmmiete/Monat (€)</label>
        <input type="number" step="0.01" data-unit="${i}" value="${existing[i] ?? ""}">
      `;
      wrap.appendChild(d);
    }
  }
  el("buildUnits").onclick=(e)=>{
    e.preventDefault();
    const units = +el("p_units").value;
    buildUnitRentFields(units, readUnitRents());
  };

  function cashflowMonth(p){
    const warm = (p.unitRents||[]).reduce((s,x)=>s+(+x||0),0);
    const util = +p.utilitiesMonthly||0;
    const rate = +p.loan.paymentMonthly||0;
    return warm - util - rate;
  }
  function cashClass(v){ return v >= 0 ? "pos" : "neg"; }

  function render(){
    el("yearLabel").textContent = selectedYear;
    el("loadedInfo").textContent = `Gespeichert: ${props.length} Objekt(e)`;

    const list = el("list");
    list.innerHTML="";

    if(!props.length){
      const empty = document.createElement("div");
      empty.className = "card";
      empty.innerHTML = `<div class="tiny">Noch keine Objekte gespeichert. Lege oben ein Objekt an.</div>`;
      list.appendChild(empty);
      return;
    }

    props.forEach(p=>{
      const cf = cashflowMonth(p);

      const det=document.createElement("details");
      const sum=document.createElement("summary");
      sum.innerHTML = `
        <div class="row" style="width:100%">
          <div>
            <div style="font-weight:800">${p.name}</div>
            <div class="tiny">${p.units} Einheiten · Start ${p.loan.startYm} · Rate ${fmtEur(p.loan.paymentMonthly)}/Monat</div>
          </div>
          <div class="pill">Cashflow: <b class="${cashClass(cf)}">${fmtEur(cf)}/Monat</b></div>
        </div>
      `;

      const inner=document.createElement("div");
      inner.className="inner";
      inner.innerHTML = `
        <div class="tiny" style="margin-top:10px">
          Warmmieten: ${(p.unitRents||[]).map((r,i)=>`E${i+1}: ${fmtEur(+r||0)}`).join(" · ") || "—"}
          <br>Nebenkosten: ${fmtEur(+p.utilitiesMonthly||0)}/Monat
        </div>
        <div class="hr"></div>
        <div class="row">
          <button class="btn" data-edit="${p.id}">Bearbeiten</button>
          <button class="btn danger" data-del="${p.id}">Objekt löschen</button>
        </div>
      `;

      det.appendChild(sum);
      det.appendChild(inner);
      list.appendChild(det);
    });

    // Delete
    document.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick=()=>{
        const id=b.getAttribute("data-del");
        if(!confirm("Objekt wirklich löschen?")) return;
        props=props.filter(x=>x.id!==id);
        save();
        if(editingId===id) clearForm();
        render();
      };
    });

    // Edit
    document.querySelectorAll("[data-edit]").forEach(b=>{
      b.onclick=()=>{
        const id=b.getAttribute("data-edit");
        const p=props.find(x=>x.id===id);
        if(!p) return;

        editingId=id;
        setEditMode(true);

        el("p_name").value=p.name||"";
        el("p_units").value=p.units||"";
        el("l_start").value=p.loan.startYm||"";
        el("l_principal").value=p.loan.principal ?? "";
        el("l_interest").value=p.loan.interestPa ?? "";
        el("l_payment").value=p.loan.paymentMonthly ?? "";
        el("cf_util").value=p.utilitiesMonthly ?? "";

        buildUnitRentFields(p.units, p.unitRents||[]);
        el("saveMsg").textContent="Bearbeitung geladen. Ändern → speichern.";
        window.scrollTo({top:0, behavior:"smooth"});
      };
    });
  }

  // Save / Update
  el("saveProperty").onclick=(e)=>{
    e.preventDefault();

    const name=(el("p_name").value||"").trim();
    const units=Math.max(0, Math.floor(+el("p_units").value));
    const startYm=(el("l_start").value||"").trim();

    const principal=+el("l_principal").value;
    const interestPa=+el("l_interest").value;
    const paymentMonthly=+el("l_payment").value;
    const utilitiesMonthly=+el("cf_util").value;

    const rentInputs=[...el("unitRents").querySelectorAll("input[data-unit]")];
    const unitRents=rentInputs.map(i=>+i.value||0);

    const errors=[];
    if(!name) errors.push("Objektname fehlt");
    if(!units || units<1) errors.push("Einheiten muss >=1 sein");
    if(!parseYearMonth(startYm)) errors.push("Startdatum muss YYYY-MM sein");
    if(!isFinite(principal) || principal<=0) errors.push("Startschuld ungültig");
    if(!isFinite(paymentMonthly) || paymentMonthly<=0) errors.push("Rate ungültig");
    if(rentInputs.length!==units) errors.push("Bitte Felder erstellen/aktualisieren");

    if(errors.length){
      el("saveMsg").textContent="❌ " + errors.join(" · ");
      return;
    }

    const obj = {
      id: editingId || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString
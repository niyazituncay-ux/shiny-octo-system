<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tuncay Holding – Immobilien Controlling</title>
<style>
:root{
  --bg:#0b0f17;--card:#121a2a;--line:#24304a;
  --txt:#e9f0ff;--mut:#9fb0d0;
  --pos:#37d67a;--neg:#ff6b6b;--acc:#4fa3ff;
}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt);padding:14px}
.card{max-width:1300px;margin:0 auto 14px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.right{margin-left:auto}
h1{margin:0 0 6px;font-size:28px}
h2{margin:0 0 8px;font-size:16px}
.small{color:var(--mut);font-size:12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.f{grid-column:span 12}
@media(min-width:760px){
  .sm6{grid-column:span 6}
  .sm4{grid-column:span 4}
  .sm3{grid-column:span 3}
}
label{display:block;font-size:12px;color:var(--mut);margin-bottom:6px}
input{width:100%;padding:9px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--txt)}
button{border:1px solid var(--line);background:#0b1220;color:var(--txt);padding:9px 12px;border-radius:10px}
button.primary{background:#17305e}
button.danger{background:#3a1520}
.kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(min-width:760px){.kpis{grid-template-columns:repeat(4,1fr)}}
.kpi{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:10px;cursor:pointer}
.kpi .t{font-size:12px;color:var(--mut)}
.kpi .v{font-weight:800;margin-top:6px}
.pos{color:var(--pos)}.neg{color:var(--neg)}
canvas{width:100%;height:300px}
details{border:1px solid var(--line);border-radius:12px;margin-top:10px}
summary{padding:10px;cursor:pointer}
.inner{padding:10px;border-top:1px solid var(--line)}
table{width:100%;border-collapse:collapse;margin-top:6px}
th,td{border-bottom:1px solid var(--line);padding:6px;font-size:13px;text-align:right}
th{text-align:left;color:var(--mut)}
.modalBg{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center}
.modal{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;max-width:1300px;width:96%;max-height:92vh;overflow:auto}
.hr{height:1px;background:var(--line);margin:10px 0}
.progress{height:16px;background:#0b1220;border:1px solid var(--line);border-radius:10px;overflow:hidden}
.progress>div{height:100%;background:linear-gradient(90deg,#37d67a,#4fa3ff)}
</style>
</head>
<body>

<!-- HEADER -->
<div class="card">
  <h1>Tuncay Holding</h1>
  <div class="small" id="info"></div>
  <div class="row">
    <button onclick="year--,render()">◀ Jahr</button>
    <div>Jahr: <b id="yearLbl"></b></div>
    <button onclick="year++,render()">Jahr ▶</button>
    <div class="right">
      <button class="danger" onclick="resetAll()">Reset</button>
    </div>
  </div>
</div>

<!-- FORM -->
<div class="card">
  <h2>Objekt anlegen / bearbeiten</h2>
  <div class="grid">
    <div class="f sm6"><label>Name</label><input id="name"></div>
    <div class="f sm3"><label>Einheiten</label><input id="units" type="number"></div>
    <div class="f sm3"><label>Darlehen Start (YYYY-MM)</label><input id="start"></div>

    <div class="f sm4"><label>Startschuld €</label><input id="principal" type="number"></div>
    <div class="f sm4"><label>Zins % p.a.</label><input id="interest" type="number"></div>
    <div class="f sm4"><label>Rate / Monat €</label><input id="payment" type="number"></div>

    <div class="f sm6"><label>Nebenkosten / Monat €</label><input id="util" type="number"></div>
    <div class="f sm6"><label>Sondertilgung (Jahr) €</label><input id="extra" type="number"></div>

    <div class="f">
      <label>Warmmieten je Einheit</label>
      <div id="rents"></div>
      <button onclick="buildRents()">Felder erstellen</button>
    </div>

    <div class="f">
      <button class="primary" onclick="saveObj()">Speichern</button>
      <div class="small" id="msg"></div>
    </div>
  </div>
</div>

<!-- KPI -->
<div class="card">
  <h2>Gesamtbilanz</h2>
  <div class="kpis">
    <div class="kpi" onclick="openDebt()"><div class="t">Gesamtschuld</div><div class="v" id="kDebt"></div></div>
    <div class="kpi" onclick="openCF()"><div class="t">Cashflow (Jahr)</div><div class="v" id="kCF"></div></div>
    <div class="kpi"><div class="t">Tilgung</div><div class="v" id="kTilg"></div></div>
    <div class="kpi"><div class="t">Zinsen</div><div class="v" id="kZins"></div></div>
  </div>
</div>

<!-- TARGET -->
<div class="card">
  <h2>Ziel Cashflow</h2>
  <div class="grid">
    <div class="f sm4"><label>Ziel € / Monat</label><input id="targetCF"></div>
    <div class="f sm4"><label>Mietsteigerung % p.a.</label><input id="growth"></div>
    <div class="f sm4"><label>&nbsp;</label><button onclick="saveSettings()">Speichern</button></div>
  </div>
  <div class="small" id="targetInfo"></div>
  <div class="progress"><div id="targetBar"></div></div>
</div>

<!-- CHART -->
<div class="card">
  <h2>Schuldenabbau – Gesamt</h2>
  <canvas id="chart"></canvas>
</div>

<!-- LIST -->
<div class="card">
  <h2>Objekte</h2>
  <div id="list"></div>
</div>

<!-- MODAL -->
<div class="modalBg" id="mbg">
  <div class="modal">
    <button onclick="closeModal()">Schließen</button>
    <div id="mbody"></div>
  </div>
</div>

<script>
/* === STATE === */
const KEY_DATA="tuncay_objects_full";
const KEY_SET="tuncay_settings_full";
let year=new Date().getFullYear();
let objects=JSON.parse(localStorage.getItem(KEY_DATA)||"[]");
let settings=JSON.parse(localStorage.getItem(KEY_SET)||'{"target":20000,"growth":2}');
const €=n=>new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(n||0);

/* === HELPERS === */
function persist(){localStorage.setItem(KEY_DATA,JSON.stringify(objects));}
function persistSet(){localStorage.setItem(KEY_SET,JSON.stringify(settings));}
function byId(id){return document.getElementById(id);}

/* === FORM === */
function buildRents(){
  const u=+byId("units").value||0;
  const d=byId("rents");d.innerHTML="";
  for(let i=0;i<u;i++) d.innerHTML+=`<input data-r="${i}" type="number" placeholder="Einheit ${i+1} €">`;
}
function saveObj(){
  const rents=[...document.querySelectorAll("[data-r]")].map(i=>+i.value||0);
  objects.push({
    name:byId("name").value,
    units:+byId("units").value,
    start:byId("start").value,
    principal:+byId("principal").value,
    interest:+byId("interest").value,
    payment:+byId("payment").value,
    util:+byId("util").value,
    extra:+byId("extra").value,
    rents
  });
  persist(); byId("msg").textContent="Gespeichert ✔"; render();
}

/* === CALC === */
function calcObject(o,y){
  let bal=o.principal,tilg=0,zins=0;
  const iM=o.interest/100/12;
  const startY=parseInt(o.start);
  for(let yy=startY;yy<=y;yy++){
    for(let m=1;m<=12;m++){
      const z=bal*iM;
      const t=Math.max(0,o.payment-z);
      bal-=t; tilg+=t; zins+=z;
      if(m===12 && yy===y) bal-=o.extra||0;
    }
  }
  const warm=o.rents.reduce((a,b)=>a+b,0);
  const cf=(warm-o.util-o.payment)*12-(o.extra||0);
  return{bal,tilg,zins,cf,warm};
}

/* === RENDER === */
function render(){
  byId("yearLbl").textContent=year;
  byId("info").textContent=`Gespeichert: ${objects.length} Objekt(e)`;

  let debt=0,cf=0,tilg=0,zins=0;
  objects.forEach(o=>{
    const r=calcObject(o,year);
    debt+=r.bal; cf+=r.cf; tilg+=r.tilg; zins+=r.zins;
  });

  byId("kDebt").textContent=€(debt);
  byId("kCF").textContent=€(cf);
  byId("kCF").className="v "+(cf>=0?"pos":"neg");
  byId("kTilg").textContent=€(tilg);
  byId("kZins").textContent=€(zins);

  const curMonthCF=cf/12;
  const pct=Math.min(100,Math.max(0,curMonthCF/settings.target*100));
  byId("targetInfo").textContent=`${pct.toFixed(1)} % von ${€(settings.target)} erreicht`;
  byId("targetBar").style.width=pct+"%";

  drawChart();
  renderList();
}

/* === LIST === */
function renderList(){
  const l=byId("list");l.innerHTML="";
  objects.forEach((o,i)=>{
    l.innerHTML+=`
    <details>
      <summary>${o.name}</summary>
      <div class="inner">
        Startschuld ${€(o.principal)} · Rate ${€(o.payment)}
        <div class="row">
          <button onclick="objects.splice(${i},1);persist();render()">Löschen</button>
        </div>
      </div>
    </details>`;
  });
}

/* === CHART === */
function drawChart(){
  const c=byId("chart"),ctx=c.getContext("2d");
  c.width=c.offsetWidth;c.height=300;
  ctx.clearRect(0,0,c.width,c.height);
  if(!objects.length)return;

  let pts=[];
  for(let i=0;i<=30;i++){
    let y=year+i,sum=0;
    objects.forEach(o=>sum+=calcObject(o,y).bal);
    pts.push({y,sum});
  }
  const max=Math.max(...pts.map(p=>p.sum));
  const pad=50;
  ctx.strokeStyle="#24304a";
  ctx.beginPath();ctx.moveTo(pad,10);ctx.lineTo(pad,260);ctx.lineTo(c.width-10,260);ctx.stroke();

  ctx.strokeStyle="#4fa3ff";ctx.beginPath();
  pts.forEach((p,i)=>{
    const x=pad+i*(c.width-pad-20)/(pts.length-1);
    const y=260-p.sum/max*230;
    if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
    if(i%5===0){
      ctx.fillStyle="#9fb0d0";
      ctx.fillText(p.y,x-12,280);
      ctx.fillText(Math.round(p.sum/1000)+"k€",x-20,y-6);
    }
  });
  ctx.stroke();
}

/* === MODALS === */
function openDebt(){
  let html="<h3>Monatliche Tilgung (Gesamt)</h3><table><tr><th>Objekt</th><th>Restschuld</th></tr>";
  objects.forEach(o=>{
    const r=calcObject(o,year);
    html+=`<tr><td>${o.name}</td><td>${€(r.bal)}</td></tr>`;
  });
  html+="</table>";
  openModal(html);
}
function openCF(){
  let html="<h3>Cashflow (Jahr)</h3><table><tr><th>Objekt</th><th>CF</th></tr>";
  objects.forEach(o=>{
    const r=calcObject(o,year);
    html+=`<tr><td>${o.name}</td><td>${€(r.cf)}</td></tr>`;
  });
  html+="</table>";
  openModal(html);
}
function openModal(html){
  byId("mbody").innerHTML=html;
  byId("mbg").style.display="flex";
}
function closeModal(){byId("mbg").style.display="none";}

/* === SETTINGS === */
function saveSettings(){
  settings.target=+byId("targetCF").value||settings.target;
  settings.growth=+byId("growth").value||settings.growth;
  persistSet(); render();
}

/* === RESET === */
function resetAll(){
  if(confirm("Alles löschen?")){
    objects=[];persist();render();
  }
}

byId("targetCF").value=settings.target;
byId("growth").value=settings.growth;
render();
</script>

</body>
</html>